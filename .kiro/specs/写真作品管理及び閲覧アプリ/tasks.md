# 実装計画

## フェーズ0: プロジェクト基盤構築

- [ ] 0.1 依存関係のインストールと設定 (P)
  - フロントエンド: `zustand`, `react-window`, `lodash`をpackage.jsonに追加
  - バックエンド: `rusqlite`, `kamadak-exif`, `image`, `walkdir`, `rayon`, `sha2`, `log`, `env_logger`をCargo.tomlに追加
  - Tauriプラグイン: `tauri-plugin-dialog`, `tauri-plugin-fs`を設定
  - _Requirements: 10_

- [ ] 0.2 プロジェクト構造の整備 (P)
  - `src/components/`, `src/stores/`, `src/types/`, `src/utils/`ディレクトリ作成
  - `src-tauri/src/services/`ディレクトリ作成（fs, db, exif, imageサブモジュール）
  - 型定義ファイル作成（`src/types/photo.ts`, `src/types/metadata.ts`）
  - _Requirements: 10_

- [ ] 0.3 開発環境設定とビルド確認
  - ESLint, Prettierの設定調整
  - `npm run dev`および`npm run tauri dev`の動作確認
  - クロスプラットフォームビルド設定検証
  - _Requirements: 10_

## フェーズ1: データ層とバックエンド基盤

- [ ] 1.1 SQLiteデータベースサービス実装
  - [ ] 1.1.1 データベーススキーマ定義とマイグレーション (P)
    - `photos`, `collections`, `photo_collections`, `app_metadata`テーブル作成
    - インデックス定義（rating, capture_date, added_at, is_favorite）
    - バージョン管理テーブル初期化
    - _Requirements: 3, 6, 8_
  
  - [ ] 1.1.2 基本CRUD操作実装 (P)
    - `init_database`, `insert_photo`, `update_metadata`, `get_all_photos`コマンド
    - `create_collection`, `add_photo_to_collection`, `remove_photo_from_collection`コマンド
    - エラーハンドリングとログ出力
    - _Requirements: 3, 6, 8_
  
  - [ ] 1.1.3 データベース初期化とバックアップ機能
    - アプリ起動時のDB初期化ロジック（`$APP_DATA/photo-manager/photos.db`）
    - バックアップエクスポート機能（JSONファイル出力）
    - データベース破損時の復元処理
    - _Requirements: 8_

- [ ] 1.2 ファイルシステムサービス実装
  - [ ] 1.2.1 フォルダ選択ダイアログ統合 (P)
    - `select_folder`コマンド実装（tauri-plugin-dialog使用）
    - クロスプラットフォーム対応検証
    - _Requirements: 1_
  
  - [ ] 1.2.2 画像ファイルスキャン機能 (P)
    - `scan_images`コマンド実装（walkdir使用、再帰検索）
    - 対応フォーマット判定（JPEG, PNG, WebP, HEIC）
    - 進捗レポート機構（イベント送信）
    - _Requirements: 1_

- [ ] 1.3 EXIF解析サービス実装 (P)
  - `get_exif`コマンド実装（kamadak-exif使用）
  - EXIF未対応フォーマットのハンドリング
  - 撮影日時、カメラ情報、露出パラメータ抽出
  - _Requirements: 2_

- [ ] 1.4 画像処理サービス実装
  - [ ] 1.4.1 サムネイル生成機能 (P)
    - `generate_thumbnail`コマンド実装（image crate使用）
    - 200x200pxリサイズ、アスペクト比維持
    - キャッシュディレクトリへの保存（`$CACHE_DIR/photo-manager/thumbnails/`）
    - _Requirements: 1, 9_
  
  - [ ] 1.4.2 サムネイルキャッシュ管理
    - ファイルハッシュ（SHA-256）ベースのキャッシュキー生成
    - LRUキャッシュロジック実装（最大500MB）
    - キャッシュクリア機能
    - _Requirements: 9_
  
  - [ ] 1.4.3 画像リサイズ・エクスポート機能 (P)
    - `resize_image`コマンド実装
    - EXIF情報保持オプション対応
    - バッチ処理対応（Rayon並列化）
    - _Requirements: 7_

## フェーズ2: 状態管理とコアロジック

- [ ] 2.1 Zustand状態管理ストア実装
  - [ ] 2.1.1 PhotoStoreの実装 (P)
    - 写真リスト、選択状態、表示モード管理
    - `Photo`, `PhotoMetadata`, `EXIFData`型定義
    - 永続化設定（localStorage連携）
    - _Requirements: 1, 2_
  
  - [ ] 2.1.2 FilterStoreの実装 (P)
    - フィルタ条件（タグ、レーティング、日付範囲、キーワード）管理
    - フィルタリングロジック（AND条件組み合わせ）
    - _Requirements: 4_
  
  - [ ] 2.1.3 SortStoreの実装 (P)
    - ソート条件（sortBy, sortOrder）管理
    - ソートロジック（撮影日時、ファイル名、レーティング、追加日時）
    - localStorage永続化
    - _Requirements: 5_
  
  - [ ] 2.1.4 CollectionStoreの実装 (P)
    - コレクションリスト、お気に入り状態管理
    - コレクション操作アクション
    - _Requirements: 6_

- [ ] 2.2 Tauriコマンド統合
  - [ ] 2.2.1 フォルダ読み込みフロー統合
    - `select_folder` → `scan_images` → `get_exif` → `insert_photo`の連携
    - 進捗イベントのフロントエンド受信処理
    - PhotoStore更新ロジック
    - _Requirements: 1_
  
  - [ ] 2.2.2 メタデータ更新フロー統合 (P)
    - `update_metadata`コマンド呼び出し
    - 楽観的UI更新とエラーリカバリ
    - _Requirements: 3_
  
  - [ ] 2.2.3 コレクション管理フロー統合 (P)
    - `create_collection`, `add_photo_to_collection`コマンド統合
    - CollectionStore同期
    - _Requirements: 6_

## フェーズ3: UIコンポーネント実装（表示系）

- [ ] 3.1 PhotoGridコンポーネント実装
  - [ ] 3.1.1 基本グリッドレイアウト (P)
    - CSS Gridによるレスポンシブレイアウト
    - サムネイル表示とクリックイベント処理
    - _Requirements: 1_
  
  - [ ] 3.1.2 仮想スクロール統合
    - react-window `VariableSizeGrid`実装
    - 動的カラム数計算（ウィンドウ幅対応）
    - パフォーマンス最適化（1000枚以上対応）
    - _Requirements: 1, 9_
  
  - [ ] 3.1.3 遅延ロードとキャッシュ連携
    - Intersection Observerでサムネイル遅延ロード
    - ThumbnailCacheとの統合
    - ローディングプレースホルダー表示
    - _Requirements: 1, 9_

- [ ] 3.2 PhotoViewerコンポーネント実装
  - [ ] 3.2.1 詳細表示モーダル (P)
    - フルサイズ画像表示（ウィンドウフィット）
    - モーダルオーバーレイとクローズボタン
    - _Requirements: 2_
  
  - [ ] 3.2.2 キーボードナビゲーション
    - 矢印キー（←/→）で前後画像切り替え
    - Escキーでモーダルクローズ
    - 画像プリロード（前後1枚）
    - _Requirements: 2_
  
  - [ ] 3.2.3 ズーム機能 (P)
    - ズームイン/アウトボタン
    - transform: scaleによる拡大（1.0〜5.0、0.5刻み）
    - ホイールスクロール対応
    - _Requirements: 2_
  
  - [ ] 3.2.4 EXIF情報パネル (P)
    - サイドパネルまたはオーバーレイでEXIF表示
    - 撮影日時、カメラ機種、露出パラメータ表示
    - _Requirements: 2_

- [ ] 3.3 AppLayoutとナビゲーション
  - [ ] 3.3.1 メインレイアウト構築
    - ヘッダー、サイドバー、メインコンテンツエリア
    - フォルダ選択ボタン配置
    - _Requirements: 1_
  
  - [ ] 3.3.2 ローディング・プログレスUI (P)
    - フォルダスキャン進捗バー
    - エクスポート進捗表示
    - エラートースト/通知システム
    - _Requirements: 1, 7_

## フェーズ4: UIコンポーネント実装（編集・操作系）

- [ ] 4.1 MetadataPanelコンポーネント実装
  - [ ] 4.1.1 タグ入力UI (P)
    - タグオートコンプリート（既存タグリスト）
    - タグ追加/削除機能
    - _Requirements: 3_
  
  - [ ] 4.1.2 レーティングUI (P)
    - 星アイコン（1〜5つ星）選択
    - クリックでレーティング設定
    - _Requirements: 3_
  
  - [ ] 4.1.3 説明文入力UI (P)
    - テキストエリアコンポーネント
    - debounce自動保存（500ms）
    - _Requirements: 3_
  
  - [ ] 4.1.4 メタデータパネル統合
    - 選択写真のメタデータ表示
    - 変更時のSQLiteService呼び出し
    - 楽観的UI更新
    - _Requirements: 3_

- [ ] 4.2 FilterBarコンポーネント実装
  - [ ] 4.2.1 タグフィルタUI (P)
    - マルチセレクトドロップダウン
    - 選択タグのAND条件適用
    - _Requirements: 4_
  
  - [ ] 4.2.2 レーティングフィルタUI (P)
    - 最小レーティング選択スライダー
    - _Requirements: 4_
  
  - [ ] 4.2.3 日付範囲フィルタUI (P)
    - react-datepickerによる日付選択
    - 開始日・終了日指定
    - _Requirements: 4_
  
  - [ ] 4.2.4 キーワード検索UI (P)
    - 検索入力フィールド
    - ファイル名・説明文の部分一致検索
    - _Requirements: 4_
  
  - [ ] 4.2.5 フィルタバー統合
    - FilterStore連携
    - フィルタクリアボタン
    - PhotoStoreへのフィルタ適用
    - _Requirements: 4_

- [ ] 4.3 SortControlコンポーネント実装 (P)
  - ソート項目選択ドロップダウン（撮影日時、ファイル名、レーティング、追加日時）
  - ソート順切り替えボタン（昇順/降順）
  - SortStore連携
  - _Requirements: 5_

- [ ] 4.4 CollectionManagerコンポーネント実装
  - [ ] 4.4.1 コレクション一覧サイドバー (P)
    - コレクションリスト表示
    - お気に入りリスト表示
    - コレクション選択で絞り込み
    - _Requirements: 6_
  
  - [ ] 4.4.2 コレクション作成・編集UI (P)
    - コレクション新規作成ダイアログ
    - コレクション名編集
    - _Requirements: 6_
  
  - [ ] 4.4.3 写真追加・削除機能
    - 写真をコレクションに追加（ドラッグ&ドロップまたはボタン）
    - コレクションから写真削除
    - お気に入りトグルボタン（サムネイルオーバーレイ）
    - _Requirements: 6_

- [ ] 4.5 ExportDialogコンポーネント実装
  - [ ] 4.5.1 エクスポート設定UI (P)
    - エクスポート先フォルダ選択
    - リサイズオプション（プリセット: 小/中/大、カスタム）
    - EXIF保持オプションチェックボックス
    - フォーマット選択（オリジナル/JPEG/PNG）
    - _Requirements: 7_
  
  - [ ] 4.5.2 エクスポート実行と進捗表示
    - エクスポートボタンクリック処理
    - 進捗バー表示
    - 完了通知表示
    - エラーハンドリング（失敗パスリスト表示）
    - _Requirements: 7_

## フェーズ5: 統合とテスト

- [ ] 5.1 エンドツーエンド統合
  - [ ] 5.1.1 フォルダ読み込み〜表示フロー統合テスト
    - フォルダ選択 → スキャン → DB保存 → グリッド表示の一連動作確認
    - 1000枚以上の画像でパフォーマンステスト
    - _Requirements: 1, 9_
  
  - [ ] 5.1.2 メタデータ編集フロー統合テスト
    - タグ追加 → フィルタリング → 該当写真表示確認
    - レーティング設定 → ソート → 正しい順序確認
    - _Requirements: 3, 4, 5_
  
  - [ ] 5.1.3 コレクション管理フロー統合テスト
    - コレクション作成 → 写真追加 → 絞り込み表示確認
    - お気に入り追加 → お気に入り一覧表示確認
    - _Requirements: 6_
  
  - [ ] 5.1.4 エクスポートフロー統合テスト
    - 写真選択 → エクスポート設定 → エクスポート実行 → ファイル生成確認
    - リサイズ・EXIF保持オプション検証
    - _Requirements: 7_

- [ ] 5.2 パフォーマンス最適化
  - [ ] 5.2.1 サムネイル生成の並列化検証
    - Rayon並列処理のパフォーマンス測定
    - 10,000枚スキャン時間の最適化（目標60秒以内）
    - _Requirements: 1, 9_
  
  - [ ] 5.2.2 仮想スクロールのFPS測定
    - グリッドスクロール時のフレームレート測定（目標60fps）
    - メモリ使用量監視
    - _Requirements: 9_
  
  - [ ] 5.2.3 キャッシュヒット率測定と改善
    - サムネイルキャッシュヒット率測定（目標90%以上）
    - LRU戦略調整
    - _Requirements: 9_

- [ ]* 5.3 ユニットテスト作成（オプション）
  - Rust側: FileSystemService, EXIFService, SQLiteService, ImageProcessorの主要関数
  - TypeScript側: Zustand storeのreducer、フィルタリング・ソートロジック
  - _Requirements: 1, 2, 3, 4, 5, 6, 7_

- [ ]* 5.4 E2Eテスト作成（オプション）
  - Playwright等でメインユーザーフロー自動化
  - フォルダ読み込み、詳細表示、メタデータ編集、エクスポートの主要シナリオ
  - _Requirements: 1, 2, 3, 7_

## フェーズ6: クロスプラットフォーム検証と最終調整

- [ ] 6.1 クロスプラットフォーム動作確認
  - [ ] 6.1.1 Windows環境テスト
    - ビルド実行と動作確認
    - ファイルパス、ダイアログUI検証
    - _Requirements: 10_
  
  - [ ] 6.1.2 macOS環境テスト
    - ビルド実行と動作確認
    - ネイティブメニューバー、ショートカットキー検証
    - _Requirements: 10_
  
  - [ ] 6.1.3 Linux環境テスト
    - ビルド実行と動作確認
    - ファイルシステムアクセス権限検証
    - _Requirements: 10_

- [ ] 6.2 エラーハンドリングとロギング強化
  - [ ] 6.2.1 ユーザーエラーハンドリング改善
    - 無効なフォルダパス、未選択状態での操作時のエラーメッセージ
    - フォームバリデーション強化
    - _Requirements: 1, 3, 4, 5, 6, 7_
  
  - [ ] 6.2.2 システムエラーハンドリング改善
    - ファイルI/Oエラー、DB接続エラー時の復旧処理
    - エラーログ出力（`$LOG_DIR/photo-manager.log`）
    - _Requirements: 8_
  
  - [ ] 6.2.3 ビジネスロジックエラーハンドリング
    - 重複パス登録、コレクション名重複時の通知
    - _Requirements: 3, 6_

- [ ] 6.3 UI/UX最終調整
  - [ ] 6.3.1 レスポンシブデザイン調整
    - 最小ウィンドウサイズ対応
    - グリッドカラム数の動的調整検証
    - _Requirements: 1, 9_
  
  - [ ] 6.3.2 アクセシビリティ改善
    - キーボードナビゲーション改善
    - ARIA属性追加
    - _Requirements: 2, 4, 5_
  
  - [ ] 6.3.3 スタイリング仕上げ
    - カラーテーマ統一
    - アニメーション調整
    - _Requirements: 1, 2, 3, 4, 5, 6, 7_

- [ ] 6.4 ドキュメント作成
  - ユーザーマニュアル作成（README更新）
  - 開発者向けドキュメント（アーキテクチャ、コンポーネント構成）
  - _Requirements: 全般_

## 実装優先順位

### P0（必須）: フェーズ0〜5の全タスク
コアフィーチャー（フォルダ読み込み、表示、メタデータ管理、フィルタリング、ソート、コレクション、エクスポート）の実装

### P1（推奨）: フェーズ6の主要タスク
- 6.1 クロスプラットフォーム動作確認
- 6.2 エラーハンドリング強化
- 6.3.1, 6.3.3（UI/UX調整）

### P2（オプション）:
- 5.3, 5.4 ユニットテスト・E2Eテスト
- 6.3.2 アクセシビリティ改善
- 6.4 ドキュメント作成

## 並列実行可能タスク

以下のタスクグループは並列実行可能：
- フェーズ1の各サービス実装（1.1, 1.2, 1.3, 1.4は独立）
- フェーズ2のストア実装（2.1.1〜2.1.4は独立）
- フェーズ3の各UIコンポーネント（3.1, 3.2は独立、ただし3.3は両方に依存）
- フェーズ4の各UIコンポーネント（4.1〜4.5は独立）

## 実装ノート

- **段階的デプロイ:** フェーズ1〜2完了後、基本的なフォルダ読み込み・表示機能が動作可能
- **MVP定義:** フェーズ3完了時点で最小限の閲覧アプリとして使用可能
- **フル機能リリース:** フェーズ5完了時点で全要件充足
- **テストデータ:** 開発中は少量（10〜100枚）と大量（1000枚以上）の両方のテストデータセットを準備
- **パフォーマンス目標:** 各フェーズ完了時にパフォーマンス指標（起動時間、スキャン時間、FPS）を測定し、設計書の目標値と比較
